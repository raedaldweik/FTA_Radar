<!DOCTYPE html>
<html>
<head>
  <title>Radar Chart with Excel Data</title>
  <!-- Import D3.js -->
  <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
  <!-- Import d3-tip -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
  <!-- Import SheetJS -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Radar Chart Visualization</h1>
  <input type="file" id="fileInput" />
  <div id="chart"></div>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }

    #chart {
      width: 100%;
      height: 600px;
    }

    svg {
      width: 100%;
      height: 100%;
    }
  </style>

  <script>
    document.getElementById("fileInput").addEventListener("change", handleFileUpload);

    function handleFileUpload(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet);

        // Log JSON data for debugging
        console.log("JSON Data:", jsonData);

        // Pass data to the radar chart
        createRadarChart(jsonData);
      };

      reader.readAsArrayBuffer(file);
    }

    function createRadarChart(data) {
      // Process data into required format for radar chart
      const categories = [...new Set(data.map(d => d["Company Name"]))];
      const metrics = [...new Set(data.map(d => d["Metric Name"]))];
      const maxScore = 100; // Adjust as necessary

      const processedData = categories.map(category => {
        return {
          category: category,
          metrics: metrics.map(metric => {
            const metricData = data.find(
              d => d["Company Name"] === category && d["Metric Name"] === metric
            );
            return {
              metric: metric,
              score: metricData ? metricData["Score"] : 0
            };
          })
        };
      });

      console.log("Processed Data for Chart:", processedData);

      // Chart dimensions
      const width = 600, height = 600, margin = 50;
      const radius = Math.min(width, height) / 2 - margin;

      const svg = d3
        .select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width / 2},${height / 2})`);

      const angleSlice = (2 * Math.PI) / metrics.length;

      // Scales
      const rScale = d3.scaleLinear().range([0, radius]).domain([0, maxScore]);

      // Draw axis lines
      metrics.forEach((metric, i) => {
        const angle = i * angleSlice;
        const x = radius * Math.cos(angle - Math.PI / 2);
        const y = radius * Math.sin(angle - Math.PI / 2);

        svg
          .append("line")
          .attr("x1", 0)
          .attr("y1", 0)
          .attr("x2", x)
          .attr("y2", y)
          .attr("stroke", "gray")
          .attr("stroke-width", "1px");
      });

      // Add metric labels
      metrics.forEach((metric, i) => {
        const angle = i * angleSlice;
        const x = (radius + 20) * Math.cos(angle - Math.PI / 2);
        const y = (radius + 20) * Math.sin(angle - Math.PI / 2);

        svg
          .append("text")
          .attr("x", x)
          .attr("y", y)
          .attr("text-anchor", "middle")
          .style("font-size", "12px")
          .text(metric);
      });

      // Draw radar areas for each category
      processedData.forEach(categoryData => {
        const points = categoryData.metrics
          .map((d, i) => {
            const angle = i * angleSlice;
            const x = rScale(d.score) * Math.cos(angle - Math.PI / 2);
            const y = rScale(d.score) * Math.sin(angle - Math.PI / 2);
            return [x, y];
          })
          .join(" ");

        svg
          .append("polygon")
          .attr("points", points)
          .attr("fill", "blue")
          .attr("fill-opacity", 0.1)
          .attr("stroke", "blue")
          .attr("stroke-width", 2);
      });
    }
  </script>
</body>
</html>
